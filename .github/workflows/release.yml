name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  actions: read
  checks: read

env:
  RELEASE_TAG: ${{ github.event.inputs.tag || github.ref_name }}

jobs:
  #======================================
  # Validate Release
  #======================================
  validate-release:
    name: Validate Release
    runs-on: ubuntu-22.04
    
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      is-prerelease: ${{ steps.check-prerelease.outputs.is-prerelease }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract version from tag
      id: extract-version
      run: |
        tag="${{ env.RELEASE_TAG }}"
        # Remove 'v' prefix if present
        version=${tag#v}
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "üìã Release version: $version"

    - name: Check if prerelease
      id: check-prerelease
      run: |
        version="${{ steps.extract-version.outputs.version }}"
        if [[ "$version" =~ -alpha|-beta|-rc ]]; then
          echo "is-prerelease=true" >> $GITHUB_OUTPUT
          echo "üöß This is a prerelease version: $version"
        else
          echo "is-prerelease=false" >> $GITHUB_OUTPUT
          echo "üöÄ This is a stable release: $version"
        fi

    - name: Validate version format
      run: |
        version="${{ steps.extract-version.outputs.version }}"
        
        # Validate semantic version format (with optional prerelease)
        if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.-]+)?$ ]]; then
          echo "‚ùå Invalid version format: $version"
          echo "Expected format: MAJOR.MINOR.PATCH[-PRERELEASE]"
          exit 1
        fi
        
        echo "‚úÖ Version format is valid: $version"

    - name: Validate CMakeLists.txt version
      run: |
        tag_version="${{ steps.extract-version.outputs.version }}"
        cmake_version=$(grep -E "VERSION\s+[0-9]+\.[0-9]+\.[0-9]+" CMakeLists.txt | head -1 | sed -E 's/.*VERSION\s+([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
        
        echo "üìã CMakeLists.txt version: $cmake_version"
        echo "üìã Git tag version: $tag_version"
        
        # For prereleases, only check the base version (without prerelease suffix)
        base_version=${tag_version%%-*}
        
        if [ "$cmake_version" != "$base_version" ]; then
          echo "‚ùå Version mismatch!"
          echo "   CMakeLists.txt: $cmake_version"
          echo "   Git tag (base): $base_version"
          exit 1
        fi
        
        echo "‚úÖ Version validation passed"

    - name: Check changelog
      run: |
        if [ -f "CHANGELOG.md" ]; then
          version="${{ steps.extract-version.outputs.version }}"
          if grep -q "## \[$version\]" CHANGELOG.md || grep -q "## $version" CHANGELOG.md; then
            echo "‚úÖ Changelog entry found for version $version"
          else
            echo "‚ö†Ô∏è  No changelog entry found for version $version"
            echo "Consider adding a changelog entry in CHANGELOG.md"
          fi
        else
          echo "‚ö†Ô∏è  No CHANGELOG.md file found"
        fi

  #======================================
  # Build Release Artifacts
  #======================================
  build-artifacts:
    name: Build Release Artifacts
    runs-on: ${{ matrix.os }}
    needs: validate-release
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            name: Linux
            archive: tar.gz
          - os: windows-2022
            name: Windows
            archive: zip
          - os: macos-13
            name: macOS
            archive: tar.gz

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup build environment (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build

    - name: Setup build environment (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install cmake ninja -y
        echo "Setting up Windows environment"

    - name: Setup build environment (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake ninja
        echo "Setting up macOS environment"

    - name: Build and test
      shell: bash
      run: |
        version="${{ needs.validate-release.outputs.version }}"
        
        echo "üî® Building TRLC Platform v$version for ${{ matrix.name }}"
        
        # Configure with release settings
        cmake -B build \
              -DCMAKE_BUILD_TYPE=Release \
              -DTRLC_PLATFORM_BUILD_TESTS=ON \
              -DCMAKE_INSTALL_PREFIX=install
        
        # Build
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake --build build --config Release --parallel
        else
          cmake --build build --config Release --parallel $(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 2)
        fi
        
        # Test
        cd build
        ctest --build-config Release --output-on-failure
        cd ..
        
        # Install to staging directory
        cmake --install build --config Release
        
        echo "‚úÖ Build and test completed for ${{ matrix.name }}"

    - name: Create source archive
      shell: bash
      run: |
        version="${{ needs.validate-release.outputs.version }}"
        archive_name="trlc-platform-$version-source"
        
        # Create clean source copy first
        mkdir src-archive-tmp
        
        # Copy files excluding build artifacts and git
        if [ "${{ runner.os }}" = "Windows" ]; then
          # Windows: Use robocopy for selective copy
          robocopy . src-archive-tmp /E /XD build .git .cache /XF "*.zip" "*.tar.gz" || true
          cd src-archive-tmp && powershell -Command "Compress-Archive -Path * -DestinationPath '../$archive_name.zip'" && cd ..
        else
          # Linux/macOS - create tar.gz
          if command -v rsync >/dev/null 2>&1; then
            rsync -av --exclude build --exclude .git --exclude .cache --exclude '*.zip' --exclude '*.tar.gz' ./ src-archive-tmp/
          else
            cp -r . src-archive-tmp/
            rm -rf src-archive-tmp/build src-archive-tmp/.git src-archive-tmp/.cache
            find src-archive-tmp/ -name "*.zip" -o -name "*.tar.gz" -delete 2>/dev/null || true
          fi
          tar -czf "$archive_name.tar.gz" -C src-archive-tmp .
        fi
        
        # Cleanup
        rm -rf src-archive-tmp

    - name: Create header-only package
      shell: bash
      run: |
        version="${{ needs.validate-release.outputs.version }}"
        headers_name="trlc-platform-headers-$version"
        
        # Create header-only package
        mkdir -p "$headers_name"
        if [ -d "include" ]; then
          cp -r include/* "$headers_name/" 2>/dev/null || true
        fi
        [ -f "README.md" ] && cp "README.md" "$headers_name/" || true
        [ -f "LICENSE" ] && cp "LICENSE" "$headers_name/" || true
        
        if [ "${{ matrix.archive }}" = "zip" ]; then
          cd "$headers_name" && powershell -Command "Compress-Archive -Path * -DestinationPath '../$headers_name.zip'" && cd ..
        else
          tar -czf "$headers_name.tar.gz" "$headers_name"
        fi
        
        rm -rf "$headers_name"

    - name: Create binary package
      shell: bash
      run: |
        version="${{ needs.validate-release.outputs.version }}"
        binary_name="trlc-platform-$version-${{ matrix.name }}"
        
        # Package the installation
        if [ -d "install" ]; then
          if [ "${{ matrix.archive }}" = "zip" ]; then
            cd install && powershell -Command "Compress-Archive -Path * -DestinationPath '../$binary_name.zip'" && cd ..
          else
            tar -czf "$binary_name.tar.gz" -C install .
          fi
        else
          echo "‚ö†Ô∏è Install directory not found, skipping binary package"
        fi

    - name: Generate checksums
      shell: bash
      run: |
        echo "üîê Generating checksums..."
        
        if [ "${{ runner.os }}" = "Windows" ]; then
          # Windows checksums using PowerShell
          for file in *.zip; do
            if [ -f "$file" ]; then
              powershell -Command "(Get-FileHash -Path '$file' -Algorithm SHA256).Hash.ToLower() + '  $file'" > "$file.sha256"
            fi
          done
        else
          # Linux/macOS checksums
          for file in *.tar.gz; do
            if [ -f "$file" ]; then
              # Use shasum on macOS, sha256sum on Linux
              if command -v sha256sum >/dev/null 2>&1; then
                sha256sum "$file" > "$file.sha256"
              elif command -v shasum >/dev/null 2>&1; then
                shasum -a 256 "$file" > "$file.sha256"
              else
                echo "‚ö†Ô∏è No checksum utility found"
              fi
            fi
          done
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: artifacts-${{ matrix.name }}
        path: |
          *.tar.gz
          *.zip
          *.sha256
        retention-days: 30

  #======================================
  # Create GitHub Release (Manual Trigger Only)
  #======================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-22.04
    needs: [validate-release, build-artifacts]
    if: github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Organize release assets
      run: |
        mkdir -p release-assets
        
        # Move all archives and checksums to release directory
        find artifacts/ -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" | \
        while read file; do
          cp "$file" release-assets/
        done
        
        # List all release assets
        echo "üì¶ Release assets:"
        ls -la release-assets/

    - name: Generate release notes
      run: |
        version="${{ needs.validate-release.outputs.version }}"
        
        cat > release-notes.md << EOF
        # TRLC Platform Library v$version
        
        ## üìã Release Information
        
        - **Version:** $version
        - **Release Type:** ${{ needs.validate-release.outputs.is-prerelease == 'true' && 'Pre-release' || 'Stable Release' }}
        - **Build Date:** $(date -u)
        - **Commit:** ${{ github.sha }}
        
        ## üöÄ What's New
        
        <!-- Add release notes here -->
        
        ## üì¶ Downloads
        
        ### Source Code
        - **Full Source:** \`trlc-platform-$version-source.tar.gz\`
        - **Headers Only:** \`trlc-platform-headers-$version.tar.gz\`
        
        ### Binary Packages
        - **Linux:** \`trlc-platform-$version-Linux.tar.gz\`
        - **Windows:** \`trlc-platform-$version-Windows.zip\`
        - **macOS:** \`trlc-platform-$version-macOS.tar.gz\`
        
        ## üîê Verification
        
        All release assets include SHA256 checksums for verification:
        
        \`\`\`bash
        # Verify download integrity
        sha256sum -c *.sha256
        \`\`\`
        
        ## üõ†Ô∏è Installation
        
        ### Header-Only Usage
        \`\`\`cpp
        #include "trlc/platform/core.hpp"
        
        constexpr auto arch = trlc::platform::getCpuArchitecture();
        \`\`\`
        
        ### CMake Integration
        \`\`\`cmake
        find_package(trlc-platform REQUIRED)
        target_link_libraries(your_target trlc::platform)
        \`\`\`
        
        ## üîç What's Included
        
        - ‚úÖ **Compiler Detection:** GCC, Clang, MSVC, Intel compilers
        - ‚úÖ **Platform Detection:** Windows, Linux, macOS, BSD, mobile platforms
        - ‚úÖ **Architecture Detection:** x86, ARM, MIPS, PowerPC, RISC-V, SPARC
        - ‚úÖ **Feature Detection:** C++ language features, SIMD capabilities
        - ‚úÖ **Zero Runtime Overhead:** All detection at compile time
        - ‚úÖ **Thread Safe:** Purely constexpr evaluation
        - ‚úÖ **Standards Compliant:** C++17/20/23 support
        
        ## üß™ Testing
        
        This release has been tested on:
        - **Compilers:** GCC 9+, Clang 10+, MSVC 2019+, Intel 19+
        - **Standards:** C++17, C++20, C++23
        - **Platforms:** Linux (x64, ARM64), Windows (x64), macOS (x64, ARM64)
        - **Architectures:** Native and cross-compilation testing
        
        ## üìû Support
        
        - **Issues:** [GitHub Issues](https://github.com/tranglecong/trlc-platform/issues)
        - **Examples:** [Usage Examples](https://github.com/tranglecong/trlc-platform/tree/main/examples)
        
        ---
        
        **Note:** This is a header-only library requiring C++17 or later.
        EOF

    - name: Create new release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: "TRLC Platform v${{ needs.validate-release.outputs.version }}"
        body_path: release-notes.md
        files: release-assets/*
        prerelease: ${{ needs.validate-release.outputs.is-prerelease == 'true' }}
        draft: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Organize release assets
      run: |
        mkdir -p release-assets
        
        # Move all archives and checksums to release directory
        find artifacts/ -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" | \
        while read file; do
          cp "$file" release-assets/
        done
        
        # List all release assets
        echo "üì¶ Release assets:"
        ls -la release-assets/

    - name: Generate release notes
      run: |
        version="${{ needs.validate-release.outputs.version }}"
        
        cat > release-notes.md << EOF
        # TRLC Platform Library v$version
        
        ## üìã Release Information
        
        - **Version:** $version
        - **Release Type:** ${{ needs.validate-release.outputs.is-prerelease == 'true' && 'Pre-release' || 'Stable Release' }}
        - **Build Date:** $(date -u)
        - **Commit:** ${{ github.sha }}
        
        ## üöÄ What's New
        
        <!-- Add release notes here -->
        
        ## üì¶ Downloads
        
        ### Source Code
        - **Full Source:** \`trlc-platform-$version-source.tar.gz\`
        - **Headers Only:** \`trlc-platform-headers-$version.tar.gz\`
        
        ### Binary Packages
        - **Linux:** \`trlc-platform-$version-Linux.tar.gz\`
        - **Windows:** \`trlc-platform-$version-Windows.zip\`
        - **macOS:** \`trlc-platform-$version-macOS.tar.gz\`
        
        ## üîê Verification
        
        All release assets include SHA256 checksums for verification:
        
        \`\`\`bash
        # Verify download integrity
        sha256sum -c *.sha256
        \`\`\`
        
        ## üõ†Ô∏è Installation
        
        ### Header-Only Usage
        \`\`\`cpp
        #include "trlc/platform/core.hpp"
        
        constexpr auto arch = trlc::platform::getCpuArchitecture();
        \`\`\`
        
        ### CMake Integration
        \`\`\`cmake
        find_package(trlc-platform REQUIRED)
        target_link_libraries(your_target trlc::platform)
        \`\`\`
        
        ## üîç What's Included
        
        - ‚úÖ **Compiler Detection:** GCC, Clang, MSVC, Intel compilers
        - ‚úÖ **Platform Detection:** Windows, Linux, macOS, BSD, mobile platforms
        - ‚úÖ **Architecture Detection:** x86, ARM, MIPS, PowerPC, RISC-V, SPARC
        - ‚úÖ **Feature Detection:** C++ language features, SIMD capabilities
        - ‚úÖ **Zero Runtime Overhead:** All detection at compile time
        - ‚úÖ **Thread Safe:** Purely constexpr evaluation
        - ‚úÖ **Standards Compliant:** C++17/20/23 support
        
        ## üß™ Testing
        
        This release has been tested on:
        - **Compilers:** GCC 9+, Clang 10+, MSVC 2019+, Intel 19+
        - **Standards:** C++17, C++20, C++23
        - **Platforms:** Linux (x64, ARM64), Windows (x64), macOS (x64, ARM64)
        - **Architectures:** Native and cross-compilation testing
        
        ## üìû Support
        
        - **Issues:** [GitHub Issues](https://github.com/tranglecong/trlc-platform/issues)
        - **Examples:** [Usage Examples](https://github.com/tranglecong/trlc-platform/tree/main/examples)
        
        ---
        
        **Note:** This is a header-only library requiring C++17 or later.
        EOF

  #======================================
  # Upload Assets to Existing Release  
  #======================================
  upload-assets:
    name: Upload Assets to Release
    runs-on: ubuntu-22.04
    needs: [validate-release, build-artifacts]
    if: github.event_name == 'release'
    
    permissions:
      contents: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Organize release assets
      run: |
        mkdir -p release-assets
        
        # Move all archives and checksums to release directory
        find artifacts/ -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" | \
        while read file; do
          cp "$file" release-assets/
        done
        
        # List all release assets
        echo "üì¶ Release assets:"
        ls -la release-assets/

    - name: Upload assets to existing release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        files: release-assets/*
        fail_on_unmatched_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #======================================
  # Post-Release Tasks
  #======================================
  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-22.04
    needs: [validate-release, create-release, upload-assets]
    if: |
      always() && 
      needs.validate-release.outputs.is-prerelease == 'false' && 
      (needs.create-release.result == 'success' || needs.upload-assets.result == 'success')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Create release summary
      run: |
        version="${{ needs.validate-release.outputs.version }}"
        
        echo "üéâ **TRLC Platform v$version Released!**" >> $GITHUB_STEP_SUMMARY
        echo "====================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üì¶ **Release Assets Created:**" >> $GITHUB_STEP_SUMMARY
        echo "- üìÑ Source code archives (Linux, Windows, macOS)" >> $GITHUB_STEP_SUMMARY
        echo "- üìÅ Header-only package" >> $GITHUB_STEP_SUMMARY
        echo "- üìã Binary packages for all platforms" >> $GITHUB_STEP_SUMMARY
        echo "- üîê SHA256 checksums for verification" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîó **Links:**" >> $GITHUB_STEP_SUMMARY
        echo "- üöÄ [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ env.RELEASE_TAG }})" >> $GITHUB_STEP_SUMMARY
        echo "- üí° [Examples](https://github.com/${{ github.repository }}/tree/main/examples)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ‚úÖ **Quality Assurance:**" >> $GITHUB_STEP_SUMMARY
        echo "- All tests passed across multiple platforms and compilers" >> $GITHUB_STEP_SUMMARY
        echo "- Cross-platform compatibility verified" >> $GITHUB_STEP_SUMMARY
        echo "- Version consistency validated" >> $GITHUB_STEP_SUMMARY

    - name: Notify completion
      run: |
        echo "‚úÖ Release v${{ needs.validate-release.outputs.version }} completed successfully!"
        echo "üì¢ All release artifacts are now available on GitHub Releases"